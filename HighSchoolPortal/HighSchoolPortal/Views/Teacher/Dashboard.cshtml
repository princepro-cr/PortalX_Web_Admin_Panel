@using HighSchoolPortal.Controllers
@{
    ViewData["Title"] = "Teacher Dashboard";
    var stats = ViewBag.Stats as TeacherDashboardStats;
    var teacher = ViewBag.Teacher as TeacherProfile;
    var recentGrades = ViewBag.RecentGrades as List<Grade> ?? new List<Grade>();
    var todaysAttendance = ViewBag.TodaysAttendance as List<Attendance> ?? new List<Attendance>();
    var teacherStudents = ViewBag.TeacherStudents as List<StudentProfile> ?? new List<StudentProfile>();
}

<div class="row">
    <!-- Dashboard Header with Assignment Status -->
    <div class="col-12 mb-4">
        <div class="card teacher-gradient">
            <div class="card-body text-white">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1 class="h2 mb-2">Welcome back, @teacher?.FullName!</h1>
                        <p class="mb-0 opacity-75">
                            <i class="fas fa-chalkboard-teacher me-1"></i>
                            Teacher Dashboard
                            <span class="mx-2">•</span>
                            <i class="fas fa-clock me-1"></i>
                            @DateTime.Now.ToString("dddd, MMMM dd, yyyy")
                        </p>
                        <!-- Assignment Status -->
                        @if (teacher?.Classes?.Any() == true && teacher?.Subjects?.Any() == true)
                        {
                            <div class="mt-2">
                                <span class="badge bg-light text-dark me-2">
                                    <i class="fas fa-school me-1"></i>@teacher.Classes.Count classes
                                </span>
                                <span class="badge bg-light text-dark">
                                    <i class="fas fa-book me-1"></i>@teacher.Subjects.Count subjects
                                </span>
                            </div>
                        }
                        else
                        {
                            <div class="mt-2">
                                <span class="badge bg-warning">
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    No classes/subjects assigned. Contact HR.
                                </span>
                            </div>
                        }
                    </div>
                    <div class="col-md-4 text-md-end">
                        <div class="btn-group">
                            @if (teacher?.Classes?.Any() == true)
                            {
                                <a href="/Teacher/AddGrade" class="btn btn-light me-2">
                                    <i class="fas fa-graduation-cap me-1"></i>Add Grade
                                </a>
                                <a href="/Teacher/RecordAttendance" class="btn btn-outline-light">
                                    <i class="fas fa-clipboard-check me-1"></i>Attendance
                                </a>
                            }
                            else
                            {
                                <button class="btn btn-light me-2" disabled>
                                    <i class="fas fa-graduation-cap me-1"></i>Add Grade
                                </button>
                                <button class="btn btn-outline-light" disabled>
                                    <i class="fas fa-clipboard-check me-1"></i>Attendance
                                </button>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Cards - HR Style -->
<div class="row g-4 mb-4">
    <!-- Total Students Card -->
    <div class="col-xl-3 col-lg-6">
        <div class="card stat-card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="feature-icon me-3 bg-primary">
                        <i class="fas fa-user-graduate"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h3 class="mb-0" id="studentCountDisplay">@(stats?.TotalStudents ?? 0)</h3>
                        <p class="text-muted mb-0">Total Students</p>
                    </div>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-check-circle text-success me-1"></i>
                        @(stats?.ActiveStudents ?? 0) active
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Average GPA Card -->
    <div class="col-xl-3 col-lg-6">
        <div class="card stat-card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="feature-icon me-3 bg-success">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h3 class="mb-0" id="avgGpaDisplay">@(stats?.AverageGPA.ToString("0.00") ?? "0.00")</h3>
                        <p class="text-muted mb-0">Average GPA</p>
                    </div>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas @(stats?.AverageGPA >= 3.0m ? "fa-arrow-up text-success" : stats?.AverageGPA >= 2.0m ? "fa-minus text-warning" : "fa-arrow-down text-danger") me-1"></i>
                        Class average
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Attendance Rate Card -->
    <div class="col-xl-3 col-lg-6">
        <div class="card stat-card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="feature-icon me-3 bg-warning">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h3 class="mb-0" id="avgAttendanceDisplay">@(stats?.AverageAttendance ?? 100)%</h3>
                        <p class="text-muted mb-0">Attendance Rate</p>
                    </div>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas @(stats?.AverageAttendance >= 90 ? "fa-check-circle text-success" : stats?.AverageAttendance >= 75 ? "fa-exclamation-circle text-warning" : "fa-times-circle text-danger") me-1"></i>
                        Student attendance
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Classes Card -->
    <div class="col-xl-3 col-lg-6">
        <div class="card stat-card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="feature-icon me-3 bg-info">
                        <i class="fas fa-school"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h3 class="mb-0">@(stats?.TotalClasses ?? 0)</h3>
                        <p class="text-muted mb-0">Classes</p>
                    </div>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-chalkboard me-1"></i>
                        Teaching @(teacher?.Subjects?.Count ?? 0) subjects
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Rest of your dashboard view remains the same -->
<div class="row g-4">
    <!-- Left Column -->
    <div class="col-lg-8">
        <!-- Quick Actions -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <a href="/Teacher/MyStudents" class="btn btn-primary w-100 py-3 d-flex flex-column align-items-center">
                            <i class="fas fa-user-graduate fa-2x mb-2"></i>
                            <span>My Students</span>
                            <small class="opacity-75">View all</small>
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="/Teacher/AddGrade" class="btn btn-success w-100 py-3 d-flex flex-column align-items-center">
                            <i class="fas fa-graduation-cap fa-2x mb-2"></i>
                            <span>Add Grades</span>
                            <small class="opacity-75">Record marks</small>
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="/Teacher/RecordAttendance" class="btn btn-warning w-100 py-3 d-flex flex-column align-items-center">
                            <i class="fas fa-clipboard-check fa-2x mb-2"></i>
                            <span>Attendance</span>
                            <small class="opacity-75">Mark today</small>
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="/Teacher/ClassPerformance" class="btn btn-info w-100 py-3 d-flex flex-column align-items-center">
                            <i class="fas fa-chart-bar fa-2x mb-2"></i>
                            <span>Reports</span>
                            <small class="opacity-75">View performance</small>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- My Classes Section -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-school me-2"></i>My Classes</h5>
                <a href="/Teacher/MyStudents" class="btn btn-sm btn-outline-primary">View All Students</a>
            </div>
            <div class="card-body">
                @if (teacher?.Classes?.Any() == true)
                {
                    <div class="row g-3">
                        @foreach (var classId in teacher.Classes.Take(4))
                        {
                            var classStudents = teacherStudents.Where(s => s.ClassId == classId).ToList();
                            var classGPA = classStudents.Any() ? Math.Round(classStudents.Average(s => s.GPA), 2) : 0;
                            var classAttendance = classStudents.Any() ?
                            (int)Math.Round(classStudents.Average(s => s.AttendancePercentage)) : 100;

                            <div class="col-md-6">
                                <div class="card border h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                            <h5 class="card-title mb-0">@classId</h5>
                                            <span class="badge bg-primary">@classStudents.Count students</span>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-6">
                                                <div class="text-center">
                                                    <small class="text-muted d-block">GPA</small>
                                                    <strong class="fs-5 @(classGPA >= 3.0m ? "text-success" : classGPA >= 2.0m ? "text-warning" : "text-danger")">
                                                        @classGPA.ToString("0.00")
                                                    </strong>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="text-center">
                                                    <small class="text-muted d-block">Attendance</small>
                                                    <strong class="fs-5 @(classAttendance >= 90 ? "text-success" : classAttendance >= 75 ? "text-warning" : "text-danger")">
                                                        @classAttendance%
                                                    </strong>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="d-grid gap-2">
                                            <a href="/Teacher/ClassPerformance?classId=@classId" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-chart-line me-1"></i>View Performance
                                            </a>
                                            <a href="/Teacher/RecordAttendance?classId=@classId" class="btn btn-sm btn-outline-success">
                                                <i class="fas fa-clipboard-check me-1"></i>Take Attendance
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="text-center py-4">
                        <i class="fas fa-school fa-3x text-muted mb-3"></i>
                        <p class="text-muted mb-2">No classes assigned</p>
                        <small class="text-muted">Contact HR for class assignments</small>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Right Column -->
    <div class="col-lg-4">
        <!-- Today's Attendance -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-calendar-day me-2"></i>Today's Attendance</h5>
                <span class="badge @(todaysAttendance.Any() ? "bg-success" : "bg-secondary")">
                    @todaysAttendance.Count marked
                </span>
            </div>
            <div class="card-body">
                @if (todaysAttendance.Any())
                {
                    <div class="attendance-summary mb-3">
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="mb-3">
                                    <span class="badge bg-success d-block mb-1">Present</span>
                                    <strong class="fs-4">@todaysAttendance.Count(a => a.Status == "Present")</strong>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="mb-3">
                                    <span class="badge bg-danger d-block mb-1">Absent</span>
                                    <strong class="fs-4">@todaysAttendance.Count(a => a.Status == "Absent")</strong>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid">
                        <a href="/Teacher/RecordAttendance" class="btn btn-primary">
                            <i class="fas fa-clipboard-check me-1"></i>Update Attendance
                        </a>
                    </div>
                }
                else
                {
                    <div class="text-center py-3">
                        <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                        <p class="text-muted mb-2">No attendance marked today</p>
                        <a href="/Teacher/RecordAttendance" class="btn btn-primary">
                            <i class="fas fa-clipboard-check me-1"></i>Mark Attendance
                        </a>
                    </div>
                }
            </div>
        </div>

        <!-- Top Students -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-trophy me-2"></i>Top Students</h5>
            </div>
            <div class="card-body">
                @if (teacherStudents.Any(s => s.GPA > 0))
                {
                    var topStudents = teacherStudents
                    .Where(s => s.GPA > 0)
                    .OrderByDescending(s => s.GPA)
                    .Take(3)
                    .ToList();

                    <div class="list-group list-group-flush">
                        @foreach (var student in topStudents)
                        {
                            <a href="/Teacher/StudentDetails/@student.Id"
                               class="list-group-item list-group-item-action d-flex align-items-center">
                                <img src="@student.AvatarUrl"
                                     class="rounded-circle me-3"
                                     style="width: 40px; height: 40px; object-fit: cover;"
                                     onerror="this.src='/images/default-avatar.png'">
                                <div class="flex-grow-1">
                                    <h6 class="mb-0">@student.FullName</h6>
                                    <small class="text-muted">@student.ClassId</small>
                                </div>
                                <span class="badge @(student.GPA >= 3.5m ? "bg-success" : student.GPA >= 2.5m ? "bg-warning" : "bg-danger")">
                                    @student.GPA.ToString("0.00")
                                </span>
                            </a>
                        }
                    </div>

                    <div class="text-center mt-3">
                        <a href="/Teacher/MyStudents" class="btn btn-sm btn-outline-primary">
                            View All Students
                        </a>
                    </div>
                }
                else
                {
                    <div class="text-center py-3">
                        <i class="fas fa-user-graduate fa-3x text-muted mb-3"></i>
                        <p class="text-muted mb-0">No student data available</p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Refresh dashboard data periodically
            refreshDashboardData();
            setInterval(refreshDashboardData, 30000); // Every 30 seconds
        });

        function refreshDashboardData() {
            $.ajax({
                url: '/Teacher/GetDashboardStatistics',
                type: 'GET',
                success: function(data) {
                    if (data && data.success) {
                        // Update statistics - HR style
                        $('#studentCountDisplay').text(data.stats.totalStudents);
                        $('#avgGpaDisplay').text(data.stats.averageGPA.toFixed(2));
                        $('#avgAttendanceDisplay').text(data.stats.averageAttendance + '%');
                    }
                }
            });
        }
    </script>
}
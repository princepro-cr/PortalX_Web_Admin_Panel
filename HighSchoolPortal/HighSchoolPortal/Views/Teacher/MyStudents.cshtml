@model IEnumerable<StudentProfile>
@{
    ViewData["Title"] = "My Students";
}

<div class="container-fluid px-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-1 teacher-gradient-text">My Students</h1>
            <p class="text-muted mb-0">
                <i class="fas fa-user-graduate me-1"></i>
                Total: <span class="fw-bold">@Model.Count()</span> students
                <span class="mx-2">•</span>
                <i class="fas fa-filter me-1"></i>
                <select class="form-select form-select-sm d-inline w-auto" id="classFilter">
                    <option value="">All Classes</option>
                    <option value="10A">Grade 10A</option>
                    <option value="11B">Grade 11B</option>
                    <option value="9C">Grade 9C</option>
                </select>
            </p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary" onclick="printStudentList()">
                <i class="fas fa-print me-2"></i>Print List
            </button>
            <button class="btn btn-teacher-primary" onclick="exportStudentGrades()">
                <i class="fas fa-file-excel me-2"></i>Export Grades
            </button>
            <button class="btn btn-teacher-secondary" data-bs-toggle="modal" data-bs-target="#addStudentModal">
                <i class="fas fa-user-plus me-2"></i>Add Student
            </button>
        </div>
    </div>

    <!-- Search Bar -->
    <div class="card card-teacher mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control" id="studentSearch"
                               placeholder="Search students by name, ID, or class...">
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="gradeFilter">
                        <option value="">All Grades</option>
                        <option value="9">Grade 9</option>
                        <option value="10">Grade 10</option>
                        <option value="11">Grade 11</option>
                        <option value="12">Grade 12</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Students Grid -->
    <div class="row g-4" id="studentsGrid">
        @foreach (var student in Model)
        {
            <div class="col-xl-3 col-lg-4 col-md-6" data-student-id="@student.Id"
                 data-grade="@student.GradeLevel" data-class="@student.ClassId"
                 data-status="@(student.IsActive ? "active" : "inactive")">
                <div class="card student-card h-100">
                    <div class="card-body p-4">
                        <div class="text-center mb-3">
                            <img src="@student.AvatarUrl"
                                 class="student-avatar mb-3"
                                 onerror="this.src='/images/default-avatar.png'">

                            <h5 class="mb-1">@student.FullName</h5>
                            <p class="text-muted small mb-2">@student.StudentId</p>

                            <div class="mb-3">
                                <span class="badge bg-secondary">Grade @student.GradeLevel</span>
                                <span class="badge bg-info ms-1">@student.ClassId</span>
                            </div>
                        </div>

                        <!-- Student Stats -->
                        <div class="row text-center mb-4">
                            <div class="col-6">
                                <div class="mb-2">
                                    <small class="text-muted d-block">GPA</small>
                                   @* <strong class="fs-5 @GetGradeClass(student.GPA)">
                                        @student.GPA.ToString("0.00")
                                    </strong>*@
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="mb-2">
                                    <small class="text-muted d-block">Attendance</small>
                                    <strong class="fs-5 @GetAttendanceClass(student.AttendancePercentage)">
                                        @student.AttendancePercentage%
                                    </strong>
                                </div>
                            </div>
                        </div>

                        <!-- Contact Info -->
                        <div class="student-contact mb-3">
                            <small class="text-muted d-block mb-1">
                                <i class="fas fa-envelope me-1"></i>@student.Email
                            </small>
                            @if (!string.IsNullOrEmpty(student.ParentName))
                            {
                                <small class="text-muted d-block mb-1">
                                    <i class="fas fa-user-friends me-1"></i>Parent: @student.ParentName
                                </small>
                            }
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-grid gap-2">
                            <a href="/Teacher/ViewStudent/@student.Id"
                               class="btn btn-sm btn-teacher-primary">
                                <i class="fas fa-eye me-1"></i>View Profile
                            </a>
                            <div class="btn-group" role="group">
                                <a href="/Teacher/AddGrade?studentId=@student.Id"
                                   class="btn btn-sm btn-outline-success">
                                    <i class="fas fa-plus-circle me-1"></i>Grade
                                </a>
                                <a href="#" class="btn btn-sm btn-outline-info" onclick="markAttendance('@student.Id')">
                                    <i class="fas fa-clipboard-check me-1"></i>Attendance
                                </a>
                                <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle dropdown-toggle-split"
                                        data-bs-toggle="dropdown">
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#"><i class="fas fa-comment me-2"></i>Send Message</a></li>
                                    <li><a class="dropdown-item" href="#"><i class="fas fa-file-alt me-2"></i>View Reports</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="#"><i class="fas fa-ban me-2"></i>Deactivate</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Card Footer -->
                    <div class="card-footer bg-transparent border-top">
                        <small class="text-muted">
                            <i class="fas fa-calendar me-1"></i>
                            Enrolled: @student.EnrollmentDate.ToString("MMM dd, yyyy")
                        </small>
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Empty State -->
    @if (!Model.Any())
    {
        <div class="text-center py-5">
            <div class="empty-state-icon mb-4">
                <i class="fas fa-user-graduate fa-4x text-muted"></i>
            </div>
            <h5 class="text-muted mb-3">No Students Assigned</h5>
            <p class="text-muted mb-4">You don't have any students assigned to your classes yet.</p>
            <button class="btn btn-teacher-primary" data-bs-toggle="modal" data-bs-target="#addStudentModal">
                <i class="fas fa-user-plus me-2"></i>Add Your First Student
            </button>
        </div>
    }
</div>

<!-- Add Student Modal -->
<div class="modal fade" id="addStudentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header teacher-gradient-bg text-white">
                <h5 class="modal-title">Add New Student</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addStudentForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Student ID</label>
                            <input type="text" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Grade Level</label>
                            <select class="form-select" required>
                                <option value="">Select Grade</option>
                                <option value="9">Grade 9</option>
                                <option value="10">Grade 10</option>
                                <option value="11">Grade 11</option>
                                <option value="12">Grade 12</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Class</label>
                            <select class="form-select" required>
                                <option value="">Select Class</option>
                                <option value="10A">10A</option>
                                <option value="11B">11B</option>
                                <option value="9C">9C</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Parent Name</label>
                            <input type="text" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Parent Email</label>
                            <input type="email" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Parent Phone</label>
                            <input type="tel" class="form-control">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-teacher-primary">Add Student</button>
            </div>
        </div>
    </div>
</div>

@functions {
   /*public string GetGradeClass(decimal gpa)
    {
        // if (gpa >= 3.5) return "grade-a";
        // if (gpa >= 2.5) return "grade-b";
        // if (gpa >= 1.5) return "grade-c";
        // return "grade-f";
    }*/

    public string GetAttendanceClass(int attendance)
    {
        if (attendance >= 90) return "grade-a";
        if (attendance >= 75) return "grade-b";
        return "grade-f";
    }
}

@section Styles {
    <style>
        .empty-state-icon {
            opacity: 0.5;
        }

        .student-contact {
            border-top: 1px solid #f0f0f0;
            padding-top: 1rem;
        }

        #studentsGrid {
            min-height: 400px;
        }

        .dropdown-toggle::after {
            margin-left: 0.5em;
            vertical-align: middle;
        }
    </style>
}

@section Scripts {
    <script>
        $(document).ready(function() {
            // Search functionality
            $('#studentSearch').on('input', filterStudents);
            $('#gradeFilter, #classFilter, #statusFilter').on('change', filterStudents);

            // Initialize tooltips
            $('[data-bs-toggle="tooltip"]').tooltip();
        });

        function filterStudents() {
            const searchTerm = $('#studentSearch').val().toLowerCase();
            const gradeFilter = $('#gradeFilter').val();
            const classFilter = $('#classFilter').val();
            const statusFilter = $('#statusFilter').val();

            $('.student-card').parent().each(function() {
                const $card = $(this);
                const studentName = $card.find('h5').text().toLowerCase();
                const studentId = $card.find('p.text-muted').text().toLowerCase();
                const studentGrade = $card.data('grade');
                const studentClass = $card.data('class');
                const studentStatus = $card.data('status');

                let matchesSearch = studentName.includes(searchTerm) ||
                                   studentId.includes(searchTerm) ||
                                   studentClass.toLowerCase().includes(searchTerm);

                let matchesGrade = !gradeFilter || studentGrade === gradeFilter;
                let matchesClass = !classFilter || studentClass === classFilter;
                let matchesStatus = !statusFilter || studentStatus === statusFilter;

                if (matchesSearch && matchesGrade && matchesClass && matchesStatus) {
                    $card.show();
                } else {
                    $card.hide();
                }
            });
        }

        function printStudentList() {
            const printContent = document.getElementById('studentsGrid').innerHTML;
            const originalContent = document.body.innerHTML;

            document.body.innerHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Student List - @DateTime.Now.ToString("MMM dd, yyyy")</title>
                    <style>
                        body { font-family: Arial, sans-serif; }
                        .print-header { text-align: center; margin-bottom: 2rem; }
                        .student-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; }
                        .student-card { border: 1px solid #ddd; padding: 1rem; border-radius: 8px; }
                        @@media print { .no-print { display: none; } }
                    </style>
                </head>
                <body>
                    <div class="print-header">
                        <h1>Student List</h1>
                        <p>Generated: @DateTime.Now.ToString("MMMM dd, yyyy h:mm tt")</p>
                    </div>
                    ${printContent}
                    <script>
                        window.onload = function() {
                            window.print();
                            setTimeout(function() {
                                window.location.reload();
                            }, 1000);
                        };
                    <\/script>
                </body>
                </html>
            `;
        }

        function exportStudentGrades() {
            // Implement export functionality
            alert('Export feature coming soon!');
        }

        function markAttendance(studentId) {
            // Implement quick attendance marking
            window.location.href = `/Teacher/RecordAttendance?studentId=${studentId}`;
        }

        // Add click event to student cards
        document.addEventListener('DOMContentLoaded', function() {
            const studentCards = document.querySelectorAll('.student-card');
            studentCards.forEach(card => {
                card.addEventListener('click', function(e) {
                    if (!e.target.closest('a') && !e.target.closest('button')) {
                        const link = this.querySelector('a[href*="/Teacher/ViewStudent/"]');
                        if (link) {
                            window.location.href = link.href;
                        }
                    }
                });
            });
        });
    </script>
}
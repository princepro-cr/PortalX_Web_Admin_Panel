@using HighSchoolPortal.Controllers
@{
    ViewData["Title"] = "HR Dashboard";
    var stats = ViewBag.Stats as HRDashboardStats;
    var recentStudents = ViewBag.RecentStudents as List<StudentProfile> ?? new List<StudentProfile>();
    var recentTeachers = ViewBag.RecentTeachers as List<TeacherProfile> ?? new List<TeacherProfile>();
    var passRates = ViewBag.PassRates as Dictionary<string, decimal> ?? new Dictionary<string, decimal>();

    // Set breadcrumb
    ViewBag.Breadcrumb = new List<dynamic>
    {
        new { Text = "HR Dashboard", Url = "/HR/Dashboard", Active = true }
    };
}

<div class="row">
    <!-- Dashboard Header -->
    <div class="col-12 mb-4">
        <div class="card hr-gradient">
            <div class="card-body text-white">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1 class="h2 mb-2">HR Management Dashboard</h1>
                        <p class="mb-0 opacity-75">
                            <i class="fas fa-user-tie me-1"></i>
                            School Administration Portal
                            <span class="mx-2">•</span>
                            <i class="fas fa-clock me-1"></i>
                            @DateTime.Now.ToString("dddd, MMMM dd, yyyy")
                        </p>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <div class="btn-group">
                            <a href="/HR/AddStudent" class="btn btn-light me-2">
                                <i class="fas fa-user-plus me-1"></i>Add Student
                            </a>
                            <a href="/HR/AddTeacher" class="btn btn-outline-light">
                                <i class="fas fa-user-plus me-1"></i>Add Teacher
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row g-4 mb-4">
    <div class="col-xl-3 col-lg-6">
        <div class="card stat-card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="feature-icon me-3 bg-primary">
                        <i class="fas fa-user-graduate"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h3 class="mb-0" id="totalStudentsDisplay">@(stats?.TotalStudents ?? 0)</h3>
                        <p class="text-muted mb-0">Total Students</p>
                    </div>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-check-circle text-success me-1"></i>
                        @(stats?.ActiveStudents ?? 0) active
                    </small>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-lg-6">
        <div class="card stat-card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="feature-icon me-3 bg-success">
                        <i class="fas fa-chalkboard-teacher"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h3 class="mb-0" id="totalTeachersDisplay">@(stats?.TotalTeachers ?? 0)</h3>
                        <p class="text-muted mb-0">Total Teachers</p>
                    </div>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-check-circle text-success me-1"></i>
                        @(stats?.ActiveTeachers ?? 0) active
                    </small>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-lg-6">
        <div class="card stat-card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="feature-icon me-3 bg-warning">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h3 class="mb-0">@(stats?.AverageStudentGPA.ToString("0.00") ?? "0.00")</h3>
                        <p class="text-muted mb-0">Avg. Student GPA</p>
                    </div>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas @(stats?.AverageStudentGPA >= 3.0m ? "fa-arrow-up text-success" : stats?.AverageStudentGPA >= 2.0m ? "fa-minus text-warning" : "fa-arrow-down text-danger") me-1"></i>
                        School average
                    </small>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-lg-6">
        <div class="card stat-card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="feature-icon me-3 bg-info">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h3 class="mb-0">@(stats?.AverageStudentAttendance ?? 100)%</h3>
                        <p class="text-muted mb-0">Attendance Rate</p>
                    </div>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas @(stats?.AverageStudentAttendance >= 90 ? "fa-check-circle text-success" : stats?.AverageStudentAttendance >= 75 ? "fa-exclamation-circle text-warning" : "fa-times-circle text-danger") me-1"></i>
                        Overall attendance
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- Left Column -->
    <div class="col-lg-8">
        <!-- Quick Actions -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <a href="/HR/ManageStudents" class="btn btn-primary w-100 py-3 d-flex flex-column align-items-center">
                            <i class="fas fa-user-graduate fa-2x mb-2"></i>
                            <span>Manage Students</span>
                            <small class="opacity-75">View & Edit</small>
                        </a>
                    </div>
                    <div class="col-md-4">
                        <a href="/HR/ManageTeachers" class="btn btn-success w-100 py-3 d-flex flex-column align-items-center">
                            <i class="fas fa-chalkboard-teacher fa-2x mb-2"></i>
                            <span>Manage Teachers</span>
                            <small class="opacity-75">View & Edit</small>
                        </a>
                    </div>
                    <div class="col-md-4">
                        <a href="/HR/GenerateReport" class="btn btn-info w-100 py-3 d-flex flex-column align-items-center">
                            <i class="fas fa-file-excel fa-2x mb-2"></i>
                            <span>Generate Reports</span>
                            <small class="opacity-75">Export data</small>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pass Rates by Grade -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Pass Rates by Grade</h5>
            </div>
            <div class="card-body">
                @if (passRates.Any())
                {
                    <div class="row">
                        @foreach (var (grade, rate) in passRates.OrderBy(x => x.Key))
                        {
                            <div class="col-md-3">
                                <div class="card border">
                                    <div class="card-body text-center">
                                        <h2 class="mb-2 @(rate >= 90 ? "text-success" : rate >= 75 ? "text-warning" : "text-danger")">
                                            @rate%
                                        </h2>
                                        <p class="text-muted mb-0">Grade @grade</p>
                                        <small class="text-muted">Pass Rate</small>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="text-center py-4">
                        <i class="fas fa-chart-pie fa-3x text-muted mb-3"></i>
                        <p class="text-muted mb-0">No pass rate data available</p>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Right Column -->
    <div class="col-lg-4">
        <!-- Recent Students -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-user-graduate me-2"></i>Recent Students</h5>
                <a href="/HR/ManageStudents" class="btn btn-sm btn-outline-primary">View All</a>
            </div>
            <div class="card-body">
                @if (recentStudents.Any())
                {
                    <div class="list-group list-group-flush">
                        @foreach (var student in recentStudents.Take(5))
                        {
                            <a href="/HR/StudentDetails/@student.Id"
                               class="list-group-item list-group-item-action d-flex align-items-center">
                                <img src="@student.AvatarUrl"
                                     class="rounded-circle me-3"
                                     style="width: 40px; height: 40px; object-fit: cover;"
                                     onerror="this.src='/images/default-avatar.png'">
                                <div class="flex-grow-1">
                                    <h6 class="mb-0">@student.FullName</h6>
                                    <small class="text-muted">@student.StudentId • Grade @student.GradeLevel</small>
                                </div>
                                <span class="badge @(student.IsActive ? "bg-success" : "bg-danger")">
                                    @(student.IsActive ? "Active" : "Inactive")
                                </span>
                            </a>
                        }
                    </div>
                }
                else
                {
                    <div class="text-center py-3">
                        <i class="fas fa-user-graduate fa-3x text-muted mb-3"></i>
                        <p class="text-muted mb-2">No students found</p>
                        <a href="/HR/AddStudent" class="btn btn-primary">
                            <i class="fas fa-user-plus me-1"></i>Add Student
                        </a>
                    </div>
                }
            </div>
        </div>

        <!-- Recent Teachers -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-chalkboard-teacher me-2"></i>Recent Teachers</h5>
                <a href="/HR/ManageTeachers" class="btn btn-sm btn-outline-primary">View All</a>
            </div>
            <div class="card-body">
                @if (recentTeachers.Any())
                {
                    <div class="list-group list-group-flush">
                        @foreach (var teacher in recentTeachers.Take(3))
                        {
                            <a href="/HR/TeacherDetails/@teacher.Id"
                               class="list-group-item list-group-item-action d-flex align-items-center">
                                <img src="@teacher.AvatarUrl"
                                     class="rounded-circle me-3"
                                     style="width: 40px; height: 40px; object-fit: cover;"
                                     onerror="this.src='/images/default-avatar.png'">
                                <div class="flex-grow-1">
                                    <h6 class="mb-0">@teacher.FullName</h6>
                                    <small class="text-muted">@teacher.Department</small>
                                </div>
                                <span class="badge @(teacher.IsActive ? "bg-success" : "bg-danger")">
                                    @(teacher.IsActive ? "Active" : "Inactive")
                                </span>
                            </a>
                        }
                    </div>
                }
                else
                {
                    <div class="text-center py-3">
                        <i class="fas fa-chalkboard-teacher fa-3x text-muted mb-3"></i>
                        <p class="text-muted mb-2">No teachers found</p>
                        <a href="/HR/AddTeacher" class="btn btn-primary">
                            <i class="fas fa-user-plus me-1"></i>Add Teacher
                        </a>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<style>
    .hr-gradient {
        background: linear-gradient(135deg, #7209b7 0%, #4361ee 100%) !important;
        border: none;
        border-radius: 12px;
    }
</style>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Refresh HR statistics periodically
            refreshHRStatistics();
            setInterval(refreshHRStatistics, 30000); // Every 30 seconds
        });

        function refreshHRStatistics() {
            $.ajax({
                url: '/HR/GetStudentCount',
                type: 'GET',
                success: function(data) {
                    if (data && data.count !== undefined) {
                        $('#totalStudentsDisplay').text(data.count);
                    }
                }
            });

            $.ajax({
                url: '/HR/GetTeacherCount',
                type: 'GET',
                success: function(data) {
                    if (data && data.count !== undefined) {
                        $('#totalTeachersDisplay').text(data.count);
                    }
                }
            });
        }
    </script>
}